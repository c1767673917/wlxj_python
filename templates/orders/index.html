{% extends "base.html" %}

{% block title %}订单管理 - 瑞勋物流询价{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-clipboard-list me-2"></i>订单管理
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('order.create') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>创建订单
        </a>
    </div>
</div>

<!-- 筛选栏 -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" id="filterForm">
            <div class="row g-3">
                <!-- 订单状态筛选 -->
                <div class="col-md-3">
                    <label for="status" class="form-label">订单状态</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">全部状态</option>
                        <option value="active" {{ 'selected' if status == 'active' }}>进行中</option>
                        <option value="completed" {{ 'selected' if status == 'completed' }}>已完成</option>
                        <option value="cancelled" {{ 'selected' if status == 'cancelled' }}>已取消</option>
                    </select>
                </div>
                
                <!-- 日期范围筛选 -->
                <div class="col-md-4">
                    <label class="form-label">日期范围</label>
                    <div class="input-group">
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ start_date }}" placeholder="开始日期">
                        <span class="input-group-text">至</span>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ end_date }}" placeholder="结束日期">
                    </div>
                </div>
                
                <!-- 关键词搜索 -->
                <div class="col-md-5">
                    <label for="keyword" class="form-label">关键词搜索</label>
                    <input type="text" class="form-control" id="keyword" name="keyword" 
                           value="{{ keyword }}" placeholder="订单号/仓库/地址/货物/价格/供应商">
                </div>
            </div>
            
            <!-- 快捷日期选项和操作按钮 -->
            <div class="row g-2 mt-2 align-items-end">
                <div class="col-md-6">
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small">快捷选择:</span>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickDate('today')">
                            <i class="fas fa-calendar-day me-1"></i>今天
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setQuickDate('this_month')">
                            <i class="fas fa-calendar-alt me-1"></i>本月
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-end gap-2">
                        <button type="submit" class="btn btn-outline-dark">
                            <i class="fas fa-search me-1"></i>搜索
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>重置
                        </button>
                        <button type="button" class="btn btn-outline-dark" onclick="exportOrders()" title="导出Excel">
                            <i class="fas fa-file-excel me-1"></i>导出Excel
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

{% if orders.items %}
<!-- 订单列表 -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-list me-2"></i>订单列表 ({{ orders.total }})
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th>订单号</th>
                        <th>货物信息</th>
                        <th>仓库</th>
                        <th>状态</th>
                        <th>报价数</th>
                        <th>最低价</th>
                        <th>供应商</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders.items %}
                    <tr>
                        <td>
                            <strong class="text-dark">{{ order.order_no }}</strong>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="{{ order.goods }}">
                                {{ order.goods }}
                            </div>
                        </td>
                        <td>
                            <small class="text-muted">{{ order.warehouse }}</small>
                        </td>
                        <td>
                            {% if order.status == 'active' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-clock me-1"></i>进行中
                                </span>
                            {% elif order.status == 'completed' %}
                                <span class="badge bg-primary">
                                    <i class="fas fa-check me-1"></i>已完成
                                </span>
                            {% elif order.status == 'cancelled' %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-times me-1"></i>已取消
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-info">{{ order.get_quote_count() }}</span>
                        </td>
                        <td>
                            {% if order.status == 'active' %}
                                {% set lowest_quote = order.get_lowest_quote() %}
                                {% if lowest_quote %}
                                    <span class="text-success fw-bold">￥{{ "%.2f"|format(lowest_quote.price) }}</span>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            {% elif order.status == 'completed' %}
                                {% if order.selected_price %}
                                    <span class="text-primary fw-bold">￥{{ "%.2f"|format(order.selected_price) }}</span>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.status == 'active' %}
                                {% set lowest_quote = order.get_lowest_quote() %}
                                {% if lowest_quote and lowest_quote.supplier %}
                                    <span class="text-success">{{ lowest_quote.supplier.name }}</span>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            {% elif order.status == 'completed' %}
                                {% if order.selected_supplier %}
                                    <span class="text-primary">{{ order.selected_supplier.name }}</span>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            {% else %}
                                <small class="text-muted">-</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-center lh-1">
                                <div class="text-muted mb-0">{{ order.created_at | beijing_date }}</div>
                                <small class="text-muted">{{ order.created_at | beijing_time_short }}</small>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('order.detail', order_id=order.id) }}" 
                                   class="btn btn-outline-info" title="查看详情">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if order.status == 'active' %}
                                <a href="{{ url_for('order.edit', order_id=order.id) }}" 
                                   class="btn btn-outline-primary" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger" 
                                        onclick="deleteOrder({{ order.id }}, '{{ order.order_no }}')" title="删除订单">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- 分页 -->
    {% if orders.pages > 1 %}
    <div class="card-footer">
        <nav>
            <ul class="pagination justify-content-center mb-0">
                {% if orders.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('order.index', page=orders.prev_num, status=status, start_date=start_date, end_date=end_date, keyword=keyword) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for page_num in orders.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != orders.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('order.index', page=page_num, status=status, start_date=start_date, end_date=end_date, keyword=keyword) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if orders.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('order.index', page=orders.next_num, status=status, start_date=start_date, end_date=end_date, keyword=keyword) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-clipboard-list fa-5x text-muted mb-3"></i>
    <h4 class="text-muted">
        {% if status or start_date or end_date or keyword %}
            没有找到符合条件的订单
        {% else %}
            还没有订单
        {% endif %}
    </h4>
    <p class="text-muted mb-4">
        {% if status or start_date or end_date or keyword %}
            尝试更改筛选条件或创建新订单
        {% else %}
            创建您的第一个询价订单开始使用系统
        {% endif %}
    </p>
    <div class="d-flex justify-content-center gap-2">
        {% if status or start_date or end_date or keyword %}
            <a href="{{ url_for('order.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-list me-1"></i>查看全部订单
            </a>
        {% endif %}
        <a href="{{ url_for('order.create') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>创建订单
        </a>
    </div>
</div>
{% endif %}

<!-- 删除订单确认模态框 -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    确认删除订单
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>注意：此操作不可恢复！</strong>
                </div>
                <p>您确定要删除订单 <strong id="orderNo"></strong> 吗？</p>
                <p class="text-muted small">
                    删除后，订单及其所有相关报价记录将被永久删除，无法恢复。
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>确认删除
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 工具函数：格式化本地日期为YYYY-MM-DD格式，避免时区问题
function formatLocalDate(date) {
    try {
        // 验证输入参数
        if (!date || !(date instanceof Date)) {
            console.error('formatLocalDate: 无效的日期参数', date);
            return null;
        }
        
        // 检查是否为有效日期
        if (isNaN(date.getTime())) {
            console.error('formatLocalDate: 无效的日期对象', date);
            return null;
        }
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        // 验证生成的日期字符串格式
        const dateString = `${year}-${month}-${day}`;
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        
        if (!dateRegex.test(dateString)) {
            console.error('formatLocalDate: 生成的日期格式不正确', dateString);
            return null;
        }
        
        return dateString;
    } catch (error) {
        console.error('formatLocalDate: 格式化日期时发生错误', error);
        return null;
    }
}

// 工具函数：验证日期范围是否合理
function validateDateRange(startDate, endDate) {
    try {
        if (!startDate || !endDate) {
            return { valid: true, message: '' }; // 允许部分日期为空
        }
        
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        // 检查日期是否有效
        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            return { valid: false, message: '日期格式无效，请选择正确的日期' };
        }
        
        // 检查开始日期是否大于结束日期
        if (start > end) {
            return { valid: false, message: '开始日期不能大于结束日期' };
        }
        
        // 检查日期范围是否过大（超过2年）
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        if (diffDays > 730) { // 2年
            return { valid: false, message: '日期范围不能超过2年，请缩小范围' };
        }
        
        return { valid: true, message: '' };
    } catch (error) {
        console.error('validateDateRange: 验证日期范围时发生错误', error);
        return { valid: false, message: '日期验证失败，请重新选择' };
    }
}

// 工具函数：显示错误消息
function showDateError(message) {
    // 创建临时错误提示
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-2';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 插入到筛选表单后
    const filterForm = document.getElementById('filterForm');
    filterForm.parentNode.insertBefore(alertDiv, filterForm.nextSibling);
    
    // 5秒后自动移除
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function deleteOrder(orderId, orderNo) {
    try {
        document.getElementById('orderNo').textContent = orderNo;
        document.getElementById('deleteForm').action = `{{ url_for('order.cancel', order_id=0) }}`.replace('0', orderId);
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    } catch (error) {
        console.error('deleteOrder: 显示删除对话框时发生错误', error);
        alert('操作失败，请刷新页面后重试');
    }
}

// 快捷日期设置 - 增强版本，支持错误处理和边缘情况
function setQuickDate(option) {
    try {
        const today = new Date();
        let startDate, endDate;
        
        // 检查当前日期是否有效
        if (isNaN(today.getTime())) {
            console.error('setQuickDate: 系统日期无效');
            showDateError('系统日期异常，请手动输入日期');
            return;
        }
        
        // 处理不同的快捷选项
        switch (option) {
            case 'today':
                startDate = endDate = formatLocalDate(today);
                break;
                
            case 'this_month':
                // 处理本月日期，考虑跨年等边缘情况
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                // 创建月初日期
                const monthStart = new Date(currentYear, currentMonth, 1);
                
                // 验证月初日期是否有效
                if (isNaN(monthStart.getTime())) {
                    console.error('setQuickDate: 无法创建月初日期', currentYear, currentMonth);
                    showDateError('无法设置本月日期，请手动输入');
                    return;
                }
                
                startDate = formatLocalDate(monthStart);
                endDate = formatLocalDate(today);
                break;
                
            default:
                console.error('setQuickDate: 不支持的选项', option);
                showDateError('不支持的日期选项');
                return;
        }
        
        // 验证格式化结果
        if (!startDate || !endDate) {
            console.error('setQuickDate: 日期格式化失败', option, startDate, endDate);
            showDateError('日期设置失败，请手动输入日期');
            return;
        }
        
        // 验证日期范围
        const validation = validateDateRange(startDate, endDate);
        if (!validation.valid) {
            console.error('setQuickDate: 日期范围验证失败', validation.message);
            showDateError(validation.message);
            return;
        }
        
        // 获取日期输入元素
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        if (!startDateInput || !endDateInput) {
            console.error('setQuickDate: 找不到日期输入元素');
            showDateError('页面错误，请刷新后重试');
            return;
        }
        
        // 设置日期值
        startDateInput.value = startDate;
        endDateInput.value = endDate;
        
        // 触发变更事件，确保其他脚本能够响应
        startDateInput.dispatchEvent(new Event('change'));
        endDateInput.dispatchEvent(new Event('change'));
        
        console.log(`快捷日期设置成功: ${option}, ${startDate} 到 ${endDate}`);
        
    } catch (error) {
        console.error('setQuickDate: 设置快捷日期时发生错误', error);
        showDateError('日期设置失败，请手动输入日期');
    }
}

// 重置筛选条件
function resetFilters() {
    try {
        document.getElementById('filterForm').reset();
        window.location.href = '{{ url_for("order.index") }}';
    } catch (error) {
        console.error('resetFilters: 重置筛选条件时发生错误', error);
        // 回退方案：直接跳转到首页
        window.location.href = '{{ url_for("order.index") }}';
    }
}

// 扩展自动筛选功能（保持向后兼容）
function autoFilter() {
    try {
        // 在提交前验证日期
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        const validation = validateDateRange(startDate, endDate);
        if (!validation.valid) {
            showDateError(validation.message);
            return false;
        }
        
        document.getElementById('filterForm').submit();
    } catch (error) {
        console.error('autoFilter: 自动筛选时发生错误', error);
        document.getElementById('filterForm').submit(); // 回退到直接提交
    }
}

// 初始化日期验证
document.addEventListener('DOMContentLoaded', function() {
    try {
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
        
        if (startDateInput && endDateInput) {
            // 添加日期变更监听器
            function validateCurrentDates() {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                
                if (startDate && endDate) {
                    const validation = validateDateRange(startDate, endDate);
                    if (!validation.valid) {
                        // 显示内联错误提示
                        showDateError(validation.message);
                        return false;
                    }
                }
                return true;
            }
            
            startDateInput.addEventListener('change', validateCurrentDates);
            endDateInput.addEventListener('change', validateCurrentDates);
            
            // 限制日期选择范围（防止选择过于久远的日期）
            const today = new Date();
            const maxDate = formatLocalDate(today);
            const minDate = new Date(today.getFullYear() - 5, 0, 1); // 5年前
            const minDateStr = formatLocalDate(minDate);
            
            if (maxDate && minDateStr) {
                startDateInput.setAttribute('max', maxDate);
                endDateInput.setAttribute('max', maxDate);
                startDateInput.setAttribute('min', minDateStr);
                endDateInput.setAttribute('min', minDateStr);
            }
        }
    } catch (error) {
        console.error('初始化日期验证时发生错误', error);
    }
});

// 表单提交时清理页码参数和验证日期
document.getElementById('filterForm').addEventListener('submit', function(e) {
    try {
        // 验证日期范围
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        const validation = validateDateRange(startDate, endDate);
        if (!validation.valid) {
            e.preventDefault(); // 阻止表单提交
            showDateError(validation.message);
            return false;
        }
        
        // 移除现有的page参数，确保搜索从第一页开始
        const url = new URL(window.location);
        url.searchParams.delete('page');
        window.history.replaceState({}, '', url);
        
        return true;
    } catch (error) {
        console.error('表单提交验证时发生错误', error);
        // 发生错误时允许表单正常提交，由后端处理
        return true;
    }
});

// Excel导出功能
function exportOrders() {
    try {
        // 构建导出URL，保持当前筛选条件
        const form = document.getElementById('filterForm');
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // 收集表单参数
        for (let [key, value] of formData.entries()) {
            if (value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // 构建导出URL
        const exportUrl = '{{ url_for("order.export_orders") }}?' + params.toString();
        
        // 显示导出进度提示
        const exportButton = event.target.closest('button');
        const originalHtml = exportButton.innerHTML;
        exportButton.disabled = true;
        exportButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>导出中...';
        
        // 创建隐藏的下载链接
        const downloadLink = document.createElement('a');
        downloadLink.href = exportUrl;
        downloadLink.style.display = 'none';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        
        // 模拟下载延迟后恢复按钮状态
        setTimeout(() => {
            exportButton.disabled = false;
            exportButton.innerHTML = originalHtml;
            document.body.removeChild(downloadLink);
            
            // 显示成功提示
            showExportSuccess();
        }, 2000);
        
    } catch (error) {
        console.error('导出Excel时发生错误', error);
        
        // 恢复按钮状态
        const exportButton = event.target.closest('button');
        exportButton.disabled = false;
        exportButton.innerHTML = '<i class="fas fa-file-excel me-1"></i>导出Excel';
        
        // 显示错误提示
        showExportError('导出失败，请稍后重试');
    }
}

// 显示导出成功提示
function showExportSuccess() {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show mt-2';
    alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        Excel文件导出成功！
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const filterForm = document.getElementById('filterForm');
    filterForm.parentNode.insertBefore(alertDiv, filterForm.nextSibling);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// 显示导出错误提示
function showExportError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-2';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const filterForm = document.getElementById('filterForm');
    filterForm.parentNode.insertBefore(alertDiv, filterForm.nextSibling);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}